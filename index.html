<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wall Ball Rep Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://docs.opencv.org/4.9.0/opencv.js"></script>

  <style>
    body {
      background: linear-gradient(to right, #232526, #414345);
      color: #f0f0f0;
      font-family: 'Poppins', sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
    }
    h1 {
      margin-bottom: 0.5rem;
      font-size: 2.8rem;
      color: #4CAF50;
      -webkit-animation: fadeInDown 1s ease-out;
      animation: fadeInDown 1s ease-out;
    }
    p {
      margin-bottom: 2rem;
      font-size: 1.1rem;
      color: #ccc;
    }
    #reps-container {
      font-size: 3rem;
      margin-bottom: 1.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
      background: #2c2c2c;
      padding: 1rem 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    canvas {
      max-width: 100%;
      width: 100%;
      height: auto;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      display: block;
      margin: 1rem auto;
    }
    #loader {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      background: #232526;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 2rem;
      color: #4CAF50;
    }
    .control-button {
      font-size: 1.2rem;
      padding: 1rem 2rem;
      border: none;
      border-radius: 25px;
      color: white;
      cursor: pointer;
      -webkit-transition: all 0.3s ease;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      background-image: linear-gradient(to right, #2196F3, #1976D2);
    }
    .control-button:hover {
        -webkit-transform: translateY(-3px);
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }
    .focus-view h1,
    .focus-view p,
    .focus-view .control-button,
    .focus-view canvas {
        display: none;
    }
    .focus-view #reps-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: #000;
        z-index: 2000;
    }
    .focus-view #reps {
        font-size: 25vw;
        color: #4CAF50;
    }
    #reset-button {
        background-image: linear-gradient(to right, #D32F2F, #C62828);
        margin-top: 1rem;
    }
    #hamburger-menu {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 3000;
    }
    #menu-icon {
        font-size: 1.5rem;
        cursor: pointer;
        background: #2c2c2c;
        padding: 0.5rem 0.8rem;
        border-radius: 50%;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        -webkit-transition: all 0.2s ease-in-out;
        transition: all 0.2s ease-in-out;
    }
    #menu-icon:hover {
        -webkit-transform: scale(1.1);
        transform: scale(1.1);
    }
    #menu-items {
        display: none;
        position: absolute;
        right: 0;
        top: 70px;
        background-color: #333;
        padding: 1rem 0;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.6);
        width: 280px;
        opacity: 0;
        -webkit-transform: translateY(-10px);
        transform: translateY(-10px);
        -webkit-transition: opacity 0.3s ease, -webkit-transform 0.3s ease;
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    #hamburger-menu.menu-open #menu-items {
        display: block;
        opacity: 1;
        -webkit-transform: translateY(0);
        transform: translateY(0);
    }
    .menu-item {
        padding: 1rem 1.8rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        -webkit-transition: background-color 0.2s ease;
        transition: background-color 0.2s ease;
        font-size: 1.1rem;
    }
    .menu-item:hover {
        background-color: #414345;
    }
    .menu-item label {
        cursor: pointer;
    }
    /* Custom Toggle Switch */
    .menu-item input[type="checkbox"] {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .toggle-switch {
        height: 24px;
        width: 44px;
        background-color: #555;
        border-radius: 12px;
        position: relative;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .toggle-switch::before {
        content: '';
        position: absolute;
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        border-radius: 50%;
        -webkit-transition: -webkit-transform 0.2s ease;
        transition: transform 0.2s ease;
    }
    input:checked + .toggle-switch {
        background-color: #4CAF50;
    }
    input:checked + .toggle-switch::before {
        -webkit-transform: translateX(20px);
        transform: translateX(20px);
    }
    #account-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        -webkit-transform: translate(-50%, -50%);
        transform: translate(-50%, -50%);
        background: #333;
        padding: 2rem;
        border-radius: 10px;
        z-index: 4000;
        width: 300px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    }
    .input-container {
        position: relative;
        margin-bottom: 1rem;
    }
    #account-modal input {
        width: 100%;
        padding: 0.8rem;
        border: 1px solid #555;
        background: #2c2c2c;
        color: #f0f0f0;
        border-radius: 5px;
        box-sizing: border-box;
    }
    .clear-input {
        position: absolute;
        right: 10px;
        top: 50%;
        -webkit-transform: translateY(-50%);
        transform: translateY(-50%);
        cursor: pointer;
        color: #999;
        font-weight: bold;
    }
    #account-modal .close-button {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        color: #f0f0f0;
        font-size: 1.5rem;
        cursor: pointer;
    }
    #history-panel {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 3500;
        color: white;
        padding: 2rem;
        box-sizing: border-box;
        display: none;
        flex-direction: column;
        align-items: center;
    }
    #history-panel h2 {
        color: #4CAF50;
    }
    #history-panel .close-history {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 2rem;
        cursor: pointer;
    }
    #version-counter {
        position: fixed;
        bottom: 5px;
        right: 10px;
        font-size: 0.8rem;
        color: #555;
        z-index: 5000;
    }
    @-webkit-keyframes fadeInDown {
        from { opacity: 0; -webkit-transform: translate3d(0, -20px, 0); }
        to { opacity: 1; -webkit-transform: translate3d(0, 0, 0); }
    }
    @keyframes fadeInDown {
        from { opacity: 0; transform: translate3d(0, -20px, 0); }
        to { opacity: 1; transform: translate3d(0, 0, 0); }
    }
    .button-container {
        margin-bottom: 1rem;
    }
    .slider-container {
        margin: 1rem auto;
        width: 80%;
        max-width: 400px;
    }
  </style>
</head>
<body>
  <div id="loader">Loading OpenCV.js...</div>
  <div class="container">
    <h1>Wall Ball Rep Tracker</h1>
    <p>Use your camera to count your wall ball reps automatically.</p>
    <div id="reps-container">
      <div id="reps">Reps: 0</div>
      <div id="timer-container">Time: 0s</div>
    </div>
    <div class="button-container">
        <button id="save-button" class="control-button">Save</button>
        <button id="reset-button" class="control-button">Reset</button>
    </div>
    <canvas id="canvas"></canvas>
    <video id="video" autoplay playsinline muted style="display: none;"></video>
    <button id="focus-mode-button" class="control-button">Focus Mode</button>
    <div class="slider-container">
        <label for="sensitivity-slider">Sensitivity</label>
        <input type="range" id="sensitivity-slider" min="500" max="5000" value="2000">
        <span id="sensitivity-value">2000</span>
    </div>
  </div>

  <div id="hamburger-menu" class="menu-closed">
    <div id="menu-icon">&#9776;</div>
    <div id="menu-items">
        <div class="menu-item" id="account-label">Account</div>
        <div class="menu-item" id="history-label">History</div>
        <div class="menu-item">
            <label for="toggle-detection">Show Sleeve Detection</label>
            <label class="toggle-label">
                <input type="checkbox" id="toggle-detection">
                <span class="toggle-switch"></span>
            </label>
        </div>
        <div class="menu-item">
            <label for="toggle-timer">Show Timer</label>
            <label class="toggle-label">
                <input type="checkbox" id="toggle-timer" checked>
                <span class="toggle-switch"></span>
            </label>
        </div>
    </div>
  </div>

  <div id="account-modal" style="display:none;">
      <button class="close-button">&times;</button>
      <h2>Account</h2>
      <div class="input-container">
        <input type="text" id="username" placeholder="Username">
        <span class="clear-input" data-for="username">&times;</span>
      </div>
      <div class="input-container">
        <input type="password" id="password" placeholder="Password">
        <span class="clear-input" data-for="password">&times;</span>
      </div>
      <button id="login-button" class="control-button">Login</button>
  </div>

  <div id="history-panel">
      <span class="close-history">&times;</span>
      <h2>Workout History</h2>
      <div id="history-content">Your saved sessions will appear here.</div>
  </div>

  <audio id="rep-sound" src="https://actions.google.com/sounds/v1/sports/tennis_ball_hit_bounce.ogg" preload="auto"></audio>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const repsDisplay = document.getElementById('reps');
    const repSound = document.getElementById('rep-sound');
    const loader = document.getElementById('loader');
    const resetButton = document.getElementById('reset-button');
    const sensitivitySlider = document.getElementById('sensitivity-slider');
    const sensitivityValue = document.getElementById('sensitivity-value');

    let reps = 0;
    let repTimestamps = [];
    let showDetection = false;
    let timerInterval;
    let seconds = 0;
    let lastRepTime = 0;
    const repCooldown = 300; // 300ms cooldown between reps

    class ArmSleeveTracker {
        constructor() {
            this.sleeveState = 'down'; // down, up
            this.lastSleeveCenterY = null;
            this.minContourArea = parseInt(sensitivitySlider.value, 10); // Minimum area to be considered a sleeve
        }

        detect(context, videoElement) {
            let src = new cv.Mat(videoElement.height, videoElement.width, cv.CV_8UC4);
            let hsv = new cv.Mat();
            let mask = new cv.Mat();
            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();

            context.drawImage(videoElement, 0, 0, videoElement.width, videoElement.height);
            src.data.set(context.getImageData(0, 0, videoElement.width, videoElement.height).data);

            cv.cvtColor(src, hsv, cv.COLOR_RGBA2RGB);
            cv.cvtColor(hsv, hsv, cv.COLOR_RGB2HSV);

            // Define range for white color in HSV
            // This might need tuning based on lighting conditions
            let lowerWhite = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [0, 0, 180, 0]);
            let upperWhite = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [180, 40, 255, 255]);
            cv.inRange(hsv, lowerWhite, upperWhite, mask);

            cv.findContours(mask, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

            let largestContour = null;
            let maxArea = 0;
            for (let i = 0; i < contours.size(); ++i) {
                let cnt = contours.get(i);
                let area = cv.contourArea(cnt, false);
                if (area > maxArea) {
                    maxArea = area;
                    largestContour = cnt;
                }
            }

            const currentTime = Date.now();

            if (largestContour && maxArea > this.minContourArea) {
                if (showDetection) {
                    let rect = cv.boundingRect(largestContour);
                    context.strokeStyle = '#00FF00';
                    context.lineWidth = 2;
                    context.strokeRect(rect.x, rect.y, rect.width, rect.height);
                }

                const M = cv.moments(largestContour);
                const sleeveCenterY = M.m01 / M.m00;

                // Rep counting logic based on vertical movement
                if (this.lastSleeveCenterY !== null) {
                    // Arm is moving up
                    if (sleeveCenterY < this.lastSleeveCenterY - 5 && this.sleeveState === 'down') { 
                        this.sleeveState = 'up';
                    }
                    // Arm is moving down after being up, count as a rep
                    else if (sleeveCenterY > this.lastSleeveCenterY + 5 && this.sleeveState === 'up') {
                        if (currentTime - lastRepTime > repCooldown) { // Cooldown
                            reps++;
                            repsDisplay.textContent = `Reps: ${reps}`;
                            repSound.play();
                            lastRepTime = currentTime;
                            repTimestamps.push(currentTime);
                        }
                        this.sleeveState = 'down';
                    }
                }
                this.lastSleeveCenterY = sleeveCenterY;
            } else {
                this.lastSleeveCenterY = null; // Reset if sleeve is not detected
            }

            src.delete();
            hsv.delete();
            mask.delete();
            contours.delete();
            hierarchy.delete();
        }
    }

    async function setupCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
        video.srcObject = stream;
        return new Promise((resolve) => {
            video.onloadedmetadata = () => {
                video.width = video.videoWidth;
                video.height = video.videoHeight;
                canvas.width = video.width;
                canvas.height = video.height;
                resolve(video);
            };
        });
    }

    function onOpenCvReady() {
        loader.style.display = 'none';
        main();
    }

    async function main() {
        await setupCamera();
        const tracker = new ArmSleeveTracker();

        let frameCount = 0;
        function gameLoop() {
            frameCount++;
            if (frameCount % 4 === 0) { // Process every 4th frame
                tracker.detect(ctx, video);
            }
            requestAnimationFrame(gameLoop);
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            const timerContainer = document.getElementById('timer-container');
            timerInterval = setInterval(() => {
                seconds++;
                let minutes = Math.floor(seconds / 60);
                let remainingSeconds = seconds % 60;
                timerContainer.textContent = `Time: ${minutes}m ${remainingSeconds}s`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        sensitivitySlider.addEventListener('input', (e) => {
            tracker.minContourArea = parseInt(e.target.value, 10);
            sensitivityValue.textContent = e.target.value;
        });
        }

        resetButton.addEventListener('click', () => {
            reps = 0;
            repTimestamps = [];
            repsDisplay.textContent = 'Reps: 0';
            resetTimer();
        });
        }

        function resetTimer() {
            stopTimer();
            seconds = 0;
            document.getElementById('timer-container').textContent = 'Time: 0s';
        }

        gameLoop();
        startTimer();

        // Unlock audio on first user interaction for Safari
        const unlockAudio = () => {
            repSound.play().catch(() => {});
            repSound.pause();
            repSound.currentTime = 0;
            document.body.removeEventListener('click', unlockAudio);
            document.body.removeEventListener('touchstart', unlockAudio);
        };
        document.body.addEventListener('click', unlockAudio);
        document.body.addEventListener('touchstart', unlockAudio);

        document.getElementById('reset-button').addEventListener('click', () => {
            reps = 0;
            repTimestamps = [];
            repsDisplay.textContent = 'Reps: 0';
            tracker.sleeveState = 'down';
            resetTimer();
            startTimer();
        });

        const hamburgerMenu = document.getElementById('hamburger-menu');
        const menuIcon = document.getElementById('menu-icon');

        menuIcon.addEventListener('click', (event) => {
            hamburgerMenu.classList.toggle('menu-open');
            event.stopPropagation();
        });

        window.addEventListener('click', (e) => {
            if (hamburgerMenu.classList.contains('menu-open') && !hamburgerMenu.contains(e.target)) {
                hamburgerMenu.classList.remove('menu-open');
            }
        });

        document.getElementById('toggle-detection').addEventListener('change', (e) => {
            showDetection = e.target.checked;
        });

        document.getElementById('toggle-timer').addEventListener('change', (e) => {
            document.getElementById('timer-container').style.display = e.target.checked ? 'block' : 'none';
            if(e.target.checked) {
                startTimer();
            } else {
                stopTimer();
            }
        });

        // Account Modal Logic
        const accountModal = document.getElementById('account-modal');
        document.getElementById('account-label').addEventListener('click', () => {
            accountModal.style.display = 'block';
            hamburgerMenu.classList.remove('menu-open');
        });
        accountModal.querySelector('.close-button').addEventListener('click', () => {
            accountModal.style.display = 'none';
        });
        document.getElementById('login-button').addEventListener('click', () => {
            // In a real app, you'd have login logic here.
            accountModal.style.display = 'none';
        });

        // History Panel Logic
        const historyPanel = document.getElementById('history-panel');
        document.getElementById('history-label').addEventListener('click', () => {
            historyPanel.style.display = 'flex';
            hamburgerMenu.classList.remove('menu-open');
        });
        historyPanel.querySelector('.close-history').addEventListener('click', () => {
            historyPanel.style.display = 'none';
        });

        document.querySelectorAll('.clear-input').forEach(span => {
            span.addEventListener('click', (e) => {
                const inputId = e.target.dataset.for;
                document.getElementById(inputId).value = '';
            });
        });

        const focusModeButton = document.getElementById('focus-mode-button');
        focusModeButton.addEventListener('click', () => {
            document.body.classList.toggle('focus-view');
        });

        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && document.body.classList.contains('focus-view')) {
                document.body.classList.remove('focus-view');
            }
        });

        document.getElementById('reps-container').addEventListener('click', () => {
            if (document.body.classList.contains('focus-view')) {
                document.body.classList.remove('focus-view');
            }
        });
    }

    // Check if OpenCV is loaded
    if (typeof cv !== 'undefined') {
        onOpenCvReady();
    } else {
        const script = document.querySelector('script[src*="opencv.js"]');
        script.onload = onOpenCvReady;
    }
  </script>
  <div id="version-counter">v0.10</div>
</body>
</html>
